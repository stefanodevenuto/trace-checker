# trace-checker
Simple tool to infer accuracy level in case of combined host-guest tracing sessions done with trace-cmd

## Context
With the `trace-cmd` tool is possible to start a combined tracing session, where you can trace at the same time the various events coming from a host and the ones from multiple guests in a virtualized environment.

Like that, the host instance of `trace-cmd` recovers the traces generated by the `trace-cmd agent` inside the guests, and merges all the events in a single trace file, re-adjusting the different timestamps.

This last step is the most difficult one, which leaves more than some room for accuracy error. `trace-cmd`'s developers implemented two different mechanisms to accomplish that:
- Run the `PTP` (Precision Time Protocol)
- When possible, directly use the __KVM entries__ (`kvm_scaling`) 

## Idea
During the development of the two "__protocols__" used to synchronize the two clocks, some sort of __quality__ standard was needed, not only to asses the results between different "protocols", but also for the different implementation version of the same one.

Therefore, a methodology to evaluate the overall __accuracy__ level of a combined tracing session has been proposed, and the implementation is in this repository.

At a higher level, the idea is to find events that we can define "__consequential__": given a determined event on the guest side, a specific event on the host side must be visible in the trace, originated by this last one. For each pair of events found, a difference of timestamps can be calculated, collecting different __samples__ to later exploit.

The "difficult" part is finding these peculiar pair of events. For the purpose of the work, two of this kind have been found:
- `hrtimer_start` into `kvm_exit`
- `cpu_idle` into `kvm_exit`

## Requirements
The [Kernelshark](https://git.kernel.org/pub/scm/utils/trace-cmd/kernel-shark.git/) libraries are needed, so all its dependencies are needed.